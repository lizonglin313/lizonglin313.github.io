<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä½¿ç”¨Golangæ„å»ºåŒºå—é“¾Part4ï¼šäº¤æ˜“-1 | Big Carrot</title>
<link rel="shortcut icon" href="https://lizonglin313.github.io//favicon.ico?v=1580471367203">
<link href="https://cdn.remixicon.com/releases/v2.1.0/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://lizonglin313.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="ä½¿ç”¨Golangæ„å»ºåŒºå—é“¾Part4ï¼šäº¤æ˜“-1 | Big Carrot - Atom Feed" href="https://lizonglin313.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">
<script src="https://blog-static.cnblogs.com/files/anbus/prism.js"></script>


    <meta name="description" content="
åœ¨å¯¹ç…§å®ç°æœ¬éƒ¨åˆ†å†…å®¹æ—¶ï¼Œæˆ‘è¿›è¡Œçš„ç¨å¾®å›°éš¾ï¼Œå› ä¸ºæœ¬ç¯‡ä¸­çš„å®ç°ä»£ç ä¸å‰é¢çš„ä»£ç ç›¸å·®çš„å¤ªå¤šã€‚æ‰€ä»¥ï¼Œå½“é‡åˆ°å›°éš¾æ—¶ï¼Œå°±ç›´æ¥å»æŸ¥æºç ã€‚åœ¨åé¢ä¼šæœ‰å¯¹åº”ä»£ç æ”¹åŠ¨çš„é“¾æ¥ã€‚

ä»‹ç»
äº¤æ˜“æ˜¯æ¯”ç‰¹å¸çš„æ ¸å¿ƒï¼Œå°†äº¤æ˜“å®‰å…¨å¯é çš„å­˜å‚¨æ˜¯åŒºå—é“¾å”¯ä¸€ç›®çš„ï¼Œæ‰€ä»¥æ²¡æœ‰äººå¯ä»¥åœ¨äº¤..." />
    <meta name="keywords" content="Golang,ç¬”è®°" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://lizonglin313.github.io/">
  <img class="avatar" src="https://lizonglin313.github.io//images/avatar.png?v=1580471367203" alt="">
  </a>
  <h1 class="site-title">
    Big Carrot
  </h1>
  <p class="site-description">
    äººä»¬ä¾ç„¶ç›¸ä¿¡æœªæ¥ä¼šæ›´ç²¾å½©
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
      
        <a href="/post/friends" class="menu">
          æœ‹å‹
        </a>
      
    
      
        <a href="/post/indexlink" class="menu">
          å¸¸ç”¨ç«™ç‚¹
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/lizonglin313" target="_blank">
          <i class="ri-github-line"></i>
        </a>
      
    
      
    
      
        <a href="https://weibo.com/u/3645767403?nick=lizonglin_TNcarrot&amp;is_hot=1" target="_blank">
          <i class="ri-weibo-line"></i>
        </a>
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              ä½¿ç”¨Golangæ„å»ºåŒºå—é“¾Part4ï¼šäº¤æ˜“-1
            </h2>
            <div class="post-info">
              <span>
                2019-09-07
              </span>
              <span>
                21 min read
              </span>
              
                <a href="https://lizonglin313.github.io/tag/Kf9p2vgKYl" class="post-tag">
                  # Golang
                </a>
              
                <a href="https://lizonglin313.github.io/tag/AHTdTb5Fm" class="post-tag">
                  # ç¬”è®°
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <blockquote>
<p>åœ¨å¯¹ç…§å®ç°æœ¬éƒ¨åˆ†å†…å®¹æ—¶ï¼Œæˆ‘è¿›è¡Œçš„ç¨å¾®å›°éš¾ï¼Œå› ä¸ºæœ¬ç¯‡ä¸­çš„å®ç°ä»£ç ä¸å‰é¢çš„ä»£ç ç›¸å·®çš„å¤ªå¤šã€‚æ‰€ä»¥ï¼Œå½“é‡åˆ°å›°éš¾æ—¶ï¼Œå°±ç›´æ¥å»æŸ¥æºç ã€‚åœ¨åé¢ä¼šæœ‰å¯¹åº”ä»£ç æ”¹åŠ¨çš„é“¾æ¥ã€‚</p>
</blockquote>
<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>äº¤æ˜“æ˜¯æ¯”ç‰¹å¸çš„æ ¸å¿ƒï¼Œå°†äº¤æ˜“å®‰å…¨å¯é çš„å­˜å‚¨æ˜¯åŒºå—é“¾å”¯ä¸€ç›®çš„ï¼Œæ‰€ä»¥æ²¡æœ‰äººå¯ä»¥åœ¨äº¤æ˜“åˆ›å»ºä¹‹åè¿›è¡Œä¿®æ”¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†å¼€å§‹å®ç°äº¤æ˜“ã€‚ä½†ç”±äºè¿™æ˜¯ä¸€ä¸ªè¾ƒä¸ºåºå¤§çš„éƒ¨åˆ†ï¼Œæˆ‘å°†å®ƒåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šåœ¨æœ¬éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šå®ç°äº¤æ˜“çš„é€šç”¨æœºåˆ¶ï¼Œåœ¨åç»­çš„é‚£éƒ¨åˆ†ä¸­æˆ‘ä»¬å°†ä¼šå®ç°ç»†èŠ‚éƒ¨åˆ†ã€‚</p>
<p>å¯¹äº†ï¼Œç”±äºä»£ç æ”¹åŠ¨äº†å¾ˆå¤šï¼Œå¹¶ä¸”æ²¡æœ‰å¿…è¦å…¨éƒ¨ç»†è¯´ã€‚ä½ ä»¬å¯ä»¥åœ¨<a href="https://github.com/Jeiwan/blockchain_go/compare/part_3...part_4#files_bucket">è¿™é‡Œ</a>æ‰¾åˆ°æ‰€æœ‰çš„æ”¹åŠ¨ã€‚</p>
<h2 id="there-is-no-spoonè¿™æ²¡å‹ºå­">There is no spoonï¼ˆè¿™æ²¡å‹ºå­ï¼‰</h2>
<p>å¦‚æœä½ æ›¾ç»å¼€å‘è¿‡Webåº”ç”¨ï¼Œä¸ºäº†å®ç°æ”¯ä»˜ä½ ä¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¿™æ ·çš„tablesï¼š<strong>accounts</strong> å’Œ <strong>transactions</strong> ã€‚ä¸€ä¸ªè´¦æˆ·ä¼šä¿å­˜ä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…å«ä»–ä»¬çš„ç§äººä¿¡æ¯ä»¥åŠè´¦æˆ·ä½™é¢ï¼ŒåŒæ—¶ä¸€ä¸ªäº¤æ˜“ä¼šå­˜å‚¨moneyä»ä¸€ä¸ªè´¦æˆ·åˆ°å¦ä¸€ä¸ªè´¦æˆ·çš„è½¬ç§»ä¿¡æ¯ã€‚åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œæ”¯ä»˜æ˜¯å®ç°äºä¸€ä¸ªå®Œå…¨ä¸åŒçš„æ–¹å¼ã€‚åœ¨è¿™ï¼š</p>
<ol>
<li>æ²¡æœ‰è´¦æˆ·ã€‚</li>
<li>æ²¡æœ‰ä½™é¢ã€‚</li>
<li>æ²¡æœ‰åœ°å€ã€‚</li>
<li>æ²¡æœ‰å¸ã€‚</li>
<li>æ²¡æœ‰å‘é€è€…å’Œæ¥å—è€…ã€‚</li>
</ol>
<p>å› ä¸ºåŒºå—é“¾æ˜¯ä¸€ä¸ªå…¬å…±å¼€æ”¾çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸æƒ³å­˜å‚¨é’±åŒ…æ‰€æœ‰è€…çš„æ•æ„Ÿä¿¡æ¯åœ¨é‡Œé¢ã€‚å¸ä¸ä¼šåœ¨è´¦æˆ·ä¸­è¢«æ”¶é›†ã€‚</p>
<p>äº¤æ˜“ä¸ä¼šæŠŠmoneyä»ä¸€ä¸ªåœ°å€è½¬ç§»åˆ°å¦ä¸€ä¸ªã€‚è¿™é‡Œä¹Ÿæ²¡æœ‰å­—æ®µæˆ–è€…è¯´æ˜¯ç‰¹å¾æ¥æŒæœ‰è´¦æˆ·çš„ä½™é¢ã€‚è¿™é‡Œåªæœ‰äº¤æ˜“ã€‚ä½†æ˜¯ï¼Œäº¤æ˜“é‡Œæœ‰ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h2 id="æ¯”ç‰¹å¸äº¤æ˜“">æ¯”ç‰¹å¸äº¤æ˜“</h2>
<blockquote>
<p>Githubè¯‘è€…è¡¥å……ï¼š</p>
<p>ç‚¹å‡» <a href="https://blockchain.info/zh-cn/tx/b6f6b339b546a13822192b06ccbdd817afea5311845f769702ae2912f7d94ab5">è¿™é‡Œ</a> åœ¨ blockchain.info æŸ¥çœ‹ä¸‹å›¾ä¸­çš„äº¤æ˜“ä¿¡æ¯ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2019/09/07/otOYFCE7e9d6wsh.png" alt="" loading="lazy"></figure>
</blockquote>
<p>äº¤æ˜“åŒ…å«ä¸€äº›è¾“å…¥ï¼ˆinputsï¼‰å’Œä¸€äº›è¾“å‡ºï¼ˆoutputsï¼‰ï¼š</p>
<pre><code class="language-go">type Transaction struct {
	ID   []byte
	Vin  []TXInput
	Vout []TXOutput
}
</code></pre>
<p>ä¸€ä¸ªæ–°çš„äº¤æ˜“çš„å…¥è´¦/è¾“å…¥å–å†³äºä¸Šä¸€ä¸ªäº¤æ˜“çš„å‡ºè´¦/è¾“å‡ºï¼ˆä¸è¿‡è¿™å„¿æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œæˆ‘ä»¬åœ¨ç¨åä¼šè®¨è®ºåˆ°ï¼‰ã€‚å‡ºè´¦/è¾“å‡ºæ˜¯å¸å®é™…ä¸Šå­˜å‚¨åœ¨å“ªé‡Œã€‚ä¸‹é¢çš„å›¾è¡¨å¯¹äº¤æ˜“çš„å†…åœ¨è”ç³»è¿›è¡Œäº†ç¤ºèŒƒï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2019/09/07/XlvF9EdjqyJa5Di.png" alt="" loading="lazy"></figure>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>æœ‰çš„å‡ºè´¦æ²¡æœ‰å’Œå…¥è´¦ç›¸è¿ã€‚</li>
<li>åœ¨ä¸€ä¸ªäº¤æ˜“ä¸­ï¼Œå…¥è´¦æ¶‰åŠå¤šä¸ªäº¤æ˜“çš„å‡ºè´¦ã€‚</li>
<li>ä¸€ä¸ªå…¥è´¦å¿…é¡»ä¾èµ–ä¸€ä¸ªå‡ºè´¦ã€‚</li>
</ol>
<p>æ•´ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨åƒâ€œé’±â€ã€â€œå¸â€ã€â€œèŠ±è´¹â€ã€â€œå‘å‡ºâ€ã€â€œè´¦æˆ·â€ç­‰ç­‰è¿™æ ·çš„å­—çœ¼ã€‚ä½†æ˜¯å¯¹æ¯”ç‰¹å¸å¹¶ä¸å­˜åœ¨è¿™æ ·çš„æ¦‚å¿µï¼Œäº¤æ˜“ä»…ä»…æ˜¯é€šè¿‡ä¸€ä¸ªè„šæœ¬æ¥é”å®šä¸€äº›å€¼ï¼Œè€Œè¿™äº›å®é™…çš„å€¼åªå¯ä»¥è¢«é”å®šä»–ä»¬çš„äººè§£é”ã€‚</p>
<p>ï¼ˆ Transactions just lock values with a script, which can be unlocked only by the one who locked them.ï¼‰</p>
<h2 id="äº¤æ˜“å‡ºè´¦">äº¤æ˜“å‡ºè´¦</h2>
<p>è®©æˆ‘ä»¬ä»äº¤æ˜“å‡ºè´¦å¼€å§‹ï¼š</p>
<pre><code class="language-go">type TXOutput struct {
	Value        int
	ScriptPubKey string
}
</code></pre>
<p>å®é™…ä¸Šï¼Œè¿™æ˜¯å­˜å‚¨â€œå¸â€çš„å‡ºè´¦ï¼ˆæ³¨æ„ä¸€ä¸‹ä¸Šé¢çš„â€œvalueâ€å­—æ®µï¼‰ã€‚è¿™ä¸ªå­˜å‚¨è¢«ä¸€ä¸ªä¿å­˜åœ¨__ScriptPubKey__é‡Œçš„â€œè°œé¢˜â€é”å®šã€‚å¾€æ·±äº†è¯´ï¼Œæ¯”ç‰¹å¸ä½¿ç”¨äº†ä¸€ä¸ªå«åš__Script__çš„è„šæœ¬è¯­è¨€ï¼Œå®ƒç”¨äºå®šä¹‰äº¤æ˜“è¾“å‡ºï¼ˆå‡ºè´¦ï¼‰çš„é”å®šå’Œè§£é”é€»è¾‘ã€‚è¿™ä¸ªè¯­è¨€æœ‰ä¸€äº›åŸå§‹ï¼ˆå®ƒæœ‰æ„è¿™æ ·è®¾è®¡ä»¥ä¾¿é¿å…å¯èƒ½çš„å…¥ä¾µå’Œæ»¥ç”¨ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ä¼šè®¨è®ºå®ƒçš„ç»†èŠ‚ã€‚ä½ å¯ä»¥åœ¨<a href="https://en.bitcoin.it/wiki/Script">è¿™é‡Œ</a>æ‰¾åˆ°æ‰€æœ‰ç»†èŠ‚çš„è§£é‡Šã€‚</p>
<blockquote>
<p>åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œ_value_å­—æ®µå­˜å‚¨ç€_satoshis_çš„æ•°é‡ï¼Œè€Œä¸æ˜¯æ¯”ç‰¹å¸çš„æ•°é‡ã€‚1 _satoshis_æ˜¯1äº¿æ¯”ç‰¹å¸åˆ†ä¹‹1ï¼ˆ0.00000001 BTCï¼‰ã€‚æ‰€ä»¥è¿™æ˜¯æ¯”ç‰¹å¸è´§å¸ä¸­æœ€å°çš„å•ä½ï¼ˆåƒæ˜¯åˆ†ï¼‰ã€‚</p>
</blockquote>
<p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å®ç°åœ°å€ï¼Œæˆ‘ä»¬ç°åœ¨å°†é¿å…æ¶‰åŠåˆ°å…¨éƒ¨é€»è¾‘ç›¸å…³çš„è„šæœ¬ã€‚__ScriptPubKey__å°†ä¼šå­˜å‚¨ä¸ºä¸€ä¸ªä¸“ç”¨çš„å­—æ®µï¼ˆç”¨æˆ·å®šä¹‰é’±åŒ…åœ°å€ï¼‰ã€‚</p>
<blockquote>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œæ‹¥æœ‰è„šæœ¬è¯­è¨€æ„å‘³ç€æ¯”ç‰¹å¸ä¹Ÿå¯ä»¥ç”¨åšæ™ºèƒ½åˆçº¦å¹³å°ã€‚</p>
</blockquote>
<p>å…³äºäº¤æ˜“è¾“å‡ºæœ‰ä¸€ä¸ªé‡è¦çš„ç‚¹æ˜¯å®ƒä»¬æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¿™æ„å‘³ç€ä½ ä¸èƒ½ä½¿ç”¨è¿™ä¸ªå€¼çš„ä¸€éƒ¨åˆ†ã€‚å½“ä¸€ä¸ªäº¤æ˜“è¾“å‡ºè¢«ä¸€ä¸ªæ–°çš„äº¤æ˜“å¼•ç”¨æ—¶ï¼Œå®ƒä¼šå…¨éƒ¨èŠ±è´¹ã€‚å¦‚æœè¿™ä¸ªå€¼æ¯”æ‰€éœ€è¦çš„å¤šï¼Œæ‰¾é›¶ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶è¿”å›ç»™å‘é€è€…ã€‚è¿™æœ‰äº›ç›¸ä¼¼äºç°å®ä¸–ç•Œä¸­ä½ æ”¯ä»˜çš„åœºæ™¯ï¼Œå°±æ˜¯è¯´ï¼Œä¸€ä¸ª5å…ƒçš„é’ç¥¨å»ä¹°ä¸€ä¸ª1å…ƒçš„ä¸œè¥¿ï¼Œä¼šå¾—åˆ°4å…ƒæ‰¾é›¶ã€‚</p>
<h2 id="äº¤æ˜“å…¥è´¦">äº¤æ˜“å…¥è´¦</h2>
<p>è¿™å„¿æ˜¯äº¤æ˜“å…¥è´¦ï¼š</p>
<pre><code class="language-go">type TXInput struct {
	Txid      []byte
	Vout      int
	ScriptSig string
}
</code></pre>
<p>å¦‚å‰é¢æ‰€è¿°ï¼Œä¸€ä¸ªäº¤æ˜“çš„å…¥è´¦æ¶‰åŠåˆ°å‰ä¸€ä¸ªäº¤æ˜“çš„å‡ºè´¦ï¼š<strong>Txid__å­˜å‚¨è¿™ä¸ªäº¤æ˜“çš„__ID</strong>ï¼Œ__Vout__å­˜å‚¨è¿™ä¸ªäº¤æ˜“ä¸­ä¸€ä¸ªå‡ºè´¦çš„ç´¢å¼•ã€‚__ScriptSig__æ˜¯ä¸€ä¸ªä¸ºå‡ºè´¦æ—¶æä¾›ä½¿ç”¨çš„__ScriptPubKey__æ‰€éœ€è¦æ•°æ®çš„è„šæœ¬ï¼ˆScriptSigæ˜¯ä¸ªè„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬æä¾›æ•°æ®ï¼Œæä¾›çš„æ•°æ®æ˜¯ScriptPubKeyæ‰€éœ€è¦çš„ï¼ŒScriptPubKeyæ˜¯å‡ºè´¦æ—¶æ‰€éœ€è¦çš„è„šæœ¬ï¼‰ã€‚å¦‚æœæ•°æ®æ­£ç¡®ï¼Œäº¤æ˜“å‡ºè´¦å¯ä»¥è¢«è§£é”ï¼Œå®ƒçš„å€¼å¯ä»¥ç”¨äºç”Ÿæˆæ–°çš„å‡ºè´¦ï¼›å¦‚æœä¸æ­£ç¡®ï¼Œè¿™ä¸ªå‡ºè´¦åˆ™ä¸èƒ½è¢«å…¥è´¦æ‰€å¼•ç”¨ã€‚è¿™å°±æ˜¯ä¿è¯ç”¨æˆ·ä¸èƒ½èŠ±è´¹å±äºåˆ«äººçš„å¸çš„ä¸€ä¸ªæœºåˆ¶ã€‚</p>
<p>å†è¯´ä¸€æ¬¡ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å®ç°åœ°å€ï¼Œ__ScriptSig__å°†ä»…ä»…å­˜å‚¨ä¸€ä¸ªä¸“ç”¨çš„ç”¨æˆ·å®šä¹‰é’±åŒ…åœ°å€ã€‚æˆ‘ä»¬åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šå®ç°å…¬é’¥å’Œç­¾åæ£€æŸ¥ã€‚</p>
<p>è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ã€‚äº¤æ˜“å‡ºè´¦æ˜¯â€œå¸â€æ‰€å­˜åœ¨çš„åœ°æ–¹ã€‚æ¯ä¸€ä¸ªäº¤æ˜“å‡ºè´¦éƒ½å¸¦æœ‰ä¸€ä¸ªè§£é”çš„è„šæœ¬ï¼Œå†³å®šç€è§£é”è¿™ä¸ªäº¤æ˜“å‡ºè´¦çš„é€»è¾‘ã€‚æ¯ä¸€ä¸ªæ–°çš„äº¤æ˜“å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå…¥è´¦å’Œå‡ºè´¦ã€‚ä¸€ä¸ªå…¥è´¦ä¼šå¼•ç”¨ä¸Šä¸ªäº¤æ˜“çš„å‡ºè´¦å’Œæ•°æ®(<strong>ScriptSig</strong> å­—æ®µ),è¿™äº›è¢«ç”¨æ¥åœ¨å‡ºè´¦ä¸­è§£é”è„šæœ¬å»è§£é”å¹¶ä½¿ç”¨å…¶ä¸­çš„å€¼åˆ›å»ºæ–°çš„å‡ºè´¦ã€‚ï¼ˆå¥½å§æˆ‘é•¿éš¾å¥ä¸è¿‡å…³...åŸæ–‡ï¼š An input references an output from a previous transaction and provides data (the <code>ScriptSig</code> field) that is used in the outputâ€™s unlocking script to unlock it and use its value to create new outputs.ï¼‰</p>
<p>ä½†æ˜¯ï¼Œå…ˆæœ‰è°ï¼šå…¥è´¦è¿˜æ˜¯å‡ºè´¦ï¼Ÿ</p>
<h2 id="the-eggè›‹">The eggï¼ˆè›‹ï¼‰</h2>
<p>åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œæ˜¯å…ˆæœ‰è›‹ï¼Œåæœ‰é¸¡çš„ã€‚è¿™ä¸ªäº¤æ˜“å…¥è´¦å’Œäº¤æ˜“å‡ºè´¦çš„ç›¸äº’å…³ç³»é€»è¾‘æ˜¯ç»å…¸çš„â€œé¸¡å’Œè›‹â€çš„å…³ç³»ï¼šå…¥è´¦äº§ç”Ÿå‡ºè´¦ï¼Œè€Œå‡ºè´¦ä½¿å…¥è´¦æˆä¸ºå¯èƒ½ã€‚åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œäº¤æ˜“å‡ºè´¦äº§ç”Ÿäºäº¤æ˜“å…¥è´¦ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ï¼Œå…ˆæœ‰äº¤æ˜“å‡ºè´¦ã€‚</p>
<p>å½“çŸ¿å·¥å¼€å§‹æŒ–çŸ¿æ—¶ï¼Œä»–ä¼šæ·»åŠ ä¸€ç¬”å¸åŸºäº¤æ˜“<code>coinbase</code>ï¼ˆæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå‡­ç©ºé€ å¸çš„äº¤æ˜“ï¼‰ã€‚ä¸€ä¸ªå¸åŸºäº¤æ˜“æ˜¯ä¸€ç§ç‰¹æ®Šçš„äº¤æ˜“ï¼Œä¸éœ€è¦ä»»ä½•å…ˆå‰çš„äº¤æ˜“å‡ºè´¦çš„å­˜åœ¨ã€‚å®ƒå°±ä¼šâ€œè«åå…¶å¦™çš„â€äº§ç”Ÿäº¤æ˜“å‡ºè´¦ï¼Œå¯ä»¥ç†è§£ä¸ºå‡­ç©ºé€ é’±ã€‚è¿™ä¸ªè›‹å°±ä¸éœ€è¦é¸¡ã€‚è¿™æ˜¯å¯¹çŸ¿å·¥æŒ–å‡ºæ–°å—çš„ä¸€ä¸ªå¥–åŠ±ã€‚</p>
<p>æ­£å¦‚ä½ æ‰€çŸ¥é“çš„ï¼Œåœ¨åŒºå—é“¾çš„æœ€å¼€å§‹æœ‰ä¸€ä¸ªåˆ›ä¸–åŒºå—ã€‚è¿™ä¸ªåŒºå—æ˜¯åŒºå—é“¾ä¸­æœ€å¼€å§‹çš„ä¸€ä¸ªå‡ºè´¦ã€‚ç”±äºæ²¡æœ‰å…ˆå‰çš„äº¤æ˜“å’Œè¾“å‡ºï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦å‰é¢çš„äº¤æ˜“è¾“å‡ºã€‚</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>coinbase</code>äº¤æ˜“ï¼š</p>
<pre><code class="language-go">func NewCoinbaseTX(to, data string) *Transaction {
	if data == &quot;&quot; {
		data = fmt.Sprintf(&quot;Reward to '%s'&quot;, to)
	}

	txin := TXInput{[]byte{}, -1, data}
	txout := TXOutput{subsidy, to}
	tx := Transaction{nil, []TXInput{txin}, []TXOutput{txout}}
	tx.SetID()

	return &amp;tx
}
</code></pre>
<p>ä¸€ä¸ª<code>coinbase</code>äº¤æ˜“åªæœ‰ä¸€ä¸ªè¾“å…¥ã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œå®ƒçš„<code>Txid</code>æ˜¯ç©ºçš„è€Œä¸”<code>Vout</code>ç­‰äº-1.åŒæ—¶ï¼Œä¸€ä¸ª<code>coinbase</code>äº¤æ˜“ä¹Ÿä¸éœ€è¦åœ¨<code>ScriptSig</code>ä¸­å­˜å‚¨è„šæœ¬ã€‚å–è€Œä»£ä¹‹çš„ï¼Œä¸“æœ‰æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œã€‚</p>
<blockquote>
<p>åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œæœ€å¼€å§‹çš„ä¸€ä¸ªäº¤æ˜“ä¸­å¸¦æœ‰è¿™æ ·çš„ä¿¡æ¯ï¼š â€œThe Times 03/Jan/2009 Chancellor on brink of second bailout for banksâ€. <a href="https://blockchain.info/tx/4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b?show_adv=true">åœ¨è¿™é‡Œå¯ä»¥è‡ªä¸ªçœ‹</a>ã€‚</p>
</blockquote>
<p><code>subsidy</code>æ˜¯å¥–åŠ±çš„æ€»æ•°ã€‚åœ¨åŒºå—é“¾ä¸­ï¼Œè¿™ä¸ªå€¼ä¸ä¼šå­˜å‚¨åœ¨ä»»ä½•åœ°æ–¹è€Œæ˜¯ä»…ä»…æ ¹æ®åŒºå—çš„æ€»æ•°é‡è¿›è¡Œè®¡ç®—ï¼šåŒºå—è¢«åˆ†ä¸º210000ä¸ªã€‚æŒ–è¿™äº›åˆ›ä¸–åŒºå—äº§ç”Ÿ50BTCï¼Œå¹¶ä¸”æ¯210000ä¸ªåŒºå—è¿™ä¸ªå¥–åŠ±å‡åŠã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå¥–åŠ±å­˜å‚¨ä¸ºä¸€ä¸ªå¸¸é‡ï¼ˆè‡³å°‘ç°åœ¨æ˜¯è¿™æ ·ğŸ˜‰ï¼‰ã€‚</p>
<h2 id="åœ¨åŒºå—é“¾ä¸­å­˜å‚¨äº¤æ˜“">åœ¨åŒºå—é“¾ä¸­å­˜å‚¨äº¤æ˜“</h2>
<p>ä»ç°åœ¨å¼€å§‹ï¼Œæ¯ä¸ªåŒºå—å¿…é¡»å­˜å‚¨è‡³å°‘1ä¸ªäº¤æ˜“åŒæ—¶æ²¡æœ‰å¯èƒ½æŒ–ä¸€ä¸ªä¸åŒ…å«äº¤æ˜“çš„åŒºå—ã€‚è¿™æ„å‘³æˆ‘ä»¬åº”è¯¥ç§»å‡º<code>Block</code>ä¸­çš„<code>Data</code>å­—æ®µç„¶åä»£æ›¿çš„ï¼Œå­˜å‚¨äº¤æ˜“å­—æ®µï¼š</p>
<pre><code class="language-go">type Block struct {
	Timestamp     int64
	Transactions  []*Transaction
	PrevBlockHash []byte
	Hash          []byte
	Nonce         int
}
</code></pre>
<p><code>NewBlock</code>ä»¥åŠ<code>NewGenesisBlock</code>ä¹Ÿå¿…é¡»ç›¸åº”çš„æ”¹å˜ï¼š</p>
<pre><code class="language-go">func NewBlock(transactions []*Transaction, prevBlockHash []byte) *Block {
    block := &amp;Block{time.Now().Unix(), transactions, prevBlockHash, []byte{}, 0}
    ...
}

func NewGenesisBlock(coinbase *Transaction) *Block {
    return NewBlock([]*Transaction{coinbase}, []byte{})
}
</code></pre>
<blockquote>
<p>åœ¨è¿™éƒ¨åˆ†ä»¥åŠåé¢çš„ä»£ç ä¸­ï¼Œç”±äºæˆ‘ç†è§£èƒ½åŠ›çš„åŸå› ï¼ˆæˆ–æ˜¯ä½œè€…æè¿°çš„ç•¥å¾®ç²—ç•¥ï¼‰ï¼Œè¿™éƒ¨åˆ†ä»¥åŠä»¥åçš„ä»£ç éƒ½æ˜¯åœ¨Part3å’ŒPart4ä»£ç æ¯”è¾ƒé‡Œä¸€ä¸€å¯¹åº”ç»§ç»­ä¿®æ”¹çš„ã€‚é“¾æ¥åœ¨æ–‡ç« å¼€å§‹çš„åœ°æ–¹ã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥è°ƒæ•´åˆ›å»ºåŒºå—é“¾çš„éƒ¨åˆ†ï¼š</p>
<pre><code class="language-go">func CreateBlockchain(address string) *Blockchain {
	...
	err = db.Update(func(tx *bolt.Tx) error {
		cbtx := NewCoinbaseTX(address, genesisCoinbaseData)
		genesis := NewGenesisBlock(cbtx)

		b, err := tx.CreateBucket([]byte(blocksBucket))
		err = b.Put(genesis.Hash, genesis.Serialize())
		...
	})
	...
}
</code></pre>
<blockquote>
<p>æˆ‘å°†å®Œæ•´éƒ¨åˆ†ä¹Ÿç»™å¤§å®¶è´´ä¸Šï¼š</p>
<pre><code class="language-go">// creates a new blockchain db
func CreateBlockchain(address string) *Blockchain {
	if dbExists() {
		fmt.Println(&quot;Blockchain is already exists.&quot;)
		os.Exit(1)
	}

	var tip []byte
	db, err := bolt.Open(dbFile, 0600, nil)
	if err != nil {
		log.Panic(err)
	}

	err = db.Update(func(tx *bolt.Tx) error {
		cbtx := NewCoinbaseTX(address, genesisCoinbaseData)
		genesis := NewGenesisBlock(cbtx)

		b, err := tx.CreateBucket([]byte(blocksBucket))
		if err != nil {
			log.Panic(err)
		}

		err = b.Put(genesis.Hash, genesis.Serialize())
		if err != nil {
			log.Panic(err)
		}

		err = b.Put([]byte(&quot;l&quot;), genesis.Hash)

		if err != nil {
			log.Panic(err)
		}

		tip = genesis.Hash

		return nil

	})

	if err != nil {
		log.Panic(err)
	}

	bc := Blockchain{tip, db}

	return &amp;bc
}
</code></pre>
</blockquote>
<p>ç°åœ¨ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶äº†ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯æ¥å—æŒ–å‡ºåˆ›ä¸–åŒºå—çš„å¥–åŠ±çš„ã€‚</p>
<h2 id="å·¥ä½œé‡è¯æ˜">å·¥ä½œé‡è¯æ˜</h2>
<p>å·¥ä½œé‡è¯æ˜ç®—æ³•å¿…é¡»è€ƒè™‘åˆ°å­˜å‚¨åœ¨åŒºå—ä¸­çš„äº¤æ˜“ï¼Œå»ä¿è¯åŒºå—é“¾ä½œä¸ºä¸€ä¸ªå­˜å‚¨äº¤æ˜“ä»“åº“çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨å¿…é¡»ä¿®æ”¹<code>Proof-Of-Work.prepareData</code>æ–¹æ³•ï¼š</p>
<pre><code class="language-go">func (pow *ProofOfWork) prepareData(nonce int) []byte {
	data := bytes.Join(
		[][]byte{
			pow.block.PrevBlockHash,
			pow.block.HashTransactions(), // This line was changed
			IntToHex(pow.block.Timestamp),
			IntToHex(int64(targetBits)),
			IntToHex(int64(nonce)),
		},
		[]byte{},
	)

	return data
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬ç”¨<code>pow.block.HashTransactions()</code>æ¥ä»£æ›¿<code>pow.block.Data</code>ï¼Œå°±æ˜¯ï¼š</p>
<pre><code class="language-go">func (b *Block) HashTransactions() []byte {
	var txHashes [][]byte
	var txHash [32]byte

	for _, tx := range b.Transactions {
		txHashes = append(txHashes, tx.ID)
	}
	txHash = sha256.Sum256(bytes.Join(txHashes, []byte{}))

	return txHash[:]
}
</code></pre>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨å–å“ˆå¸Œçš„åŸç†ä¸ºæ•°æ®æä¾›ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç‰¹å¾ã€‚æˆ‘ä»¬å¸Œæœ›æ‰€æœ‰åœ¨åŒºå—ä¸­çš„äº¤æ˜“éƒ½é€šè¿‡å•ç‹¬çš„ä¸€ä¸ªå“ˆå¸Œå»å”¯ä¸€çš„æ ‡è¯†è‡ªå·±ã€‚ä¸ºäº†å®ç°å®ƒï¼Œæˆ‘ä»¬å–æ¯ä¸ªäº¤æ˜“çš„å“ˆå¸Œï¼Œå°†å®ƒä»¬è¿æ¥èµ·æ¥ï¼Œç„¶åå»è®¡ç®—å®ƒä»¬è¿æ¥ç»„åˆçš„å“ˆå¸Œã€‚</p>
<blockquote>
<p>æ¯”ç‰¹å¸ä½¿ç”¨äº†æ›´åŠ å¤æ‚çš„æŠ€æœ¯ï¼šå®ƒç”¨ä¸€é¢—<a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a>ä»£è¡¨ä¸€ä¸ªåŒºå—ä¸­åŒ…å«çš„æ‰€æœ‰äº¤æ˜“å¹¶ä¸”åœ¨å·¥ä½œé‡è¯æ˜ç³»ç»Ÿä¸­ä½¿ç”¨æ ‘çš„æ ¹å“ˆå¸Œå€¼ã€‚è¿™ä¸ªæ–¹æ³•è¿è¡Œå¿«é€Ÿçš„æ£€æŸ¥ä¸€ä¸ªåŒºå—æ˜¯å¦åŒ…å«æŸä¸ªç¡®å®šçš„äº¤æ˜“ï¼Œåªéœ€è¦æ ‘æ ¹çš„å“ˆå¸Œè€Œä¸éœ€è¦ä¸‹è½½æ•´ä¸ªäº¤æ˜“ã€‚</p>
</blockquote>
<p>è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡æ˜¯å¦æ­£ç¡®ï¼š</p>
<pre><code class="language-go">$ blockchain_go createblockchain -address Ivan
00000093450837f8b52b78c25f8163bb6137caf43ff4d9a01d1b731fa8ddcc8a

Done!
</code></pre>
<blockquote>
<p>å®è¯è¯´åšåˆ°è¿™é‡Œï¼Œè¿™ä¸ªæˆ‘æ²¡åšå‡ºæ¥ï¼Œåº”è¯¥è¿˜æ˜¯ç¼ºä¸€äº›çš„ã€‚åœ¨æ•´ç¯‡æ–‡ç« æ¶‰åŠåˆ°çš„ä»£ç å…¨éƒ¨å®Œæˆåï¼Œæˆ‘æ‰å®ç°è¿™æ ·çš„å†…å®¹ã€‚</p>
</blockquote>
<p>å¥½ï¼æˆ‘ä»¬ç°åœ¨æ”¶åˆ°æˆ‘ä»¬çš„ç¬¬ä¸€ç¬”æŒ–çŸ¿å¥–åŠ±ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æ€æ ·æ£€æŸ¥æˆ‘ä»¬çš„ä½™é¢å‘¢ï¼Ÿ</p>
<h2 id="æœªèŠ±è´¹äº¤æ˜“è¾“å‡º">æœªèŠ±è´¹äº¤æ˜“è¾“å‡º</h2>
<p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å…¨éƒ¨çš„æœªèŠ±è´¹äº¤æ˜“è¾“å‡ºï¼ˆunspent transaction outputs - UTXOï¼‰ã€‚æœªèŠ±è´¹è¡¨ç¤ºè¿™äº›è¾“å‡ºæ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«ä»»ä½•äº¤æ˜“å…¥è´¦æ‰€å¼•ç”¨ï¼ˆä¹Ÿå°±æ˜¯å“ªä¸€ä¸ªäº¤æ˜“çš„å…¥è´¦éƒ½æ²¡æœ‰ä½¿ç”¨å®ƒï¼‰ã€‚åœ¨ä¸Šé¢çš„å›¾è§£ä¸­ï¼Œè¿™äº›å°±æ˜¯çš„ï¼š</p>
<ol>
<li>tx0, output 1ï¼›</li>
<li>tx1, output 0ï¼›</li>
<li>tx3, output 0ï¼›</li>
<li>tx4, output 0ã€‚</li>
</ol>
<p>å½“ç„¶ï¼Œåœ¨æˆ‘ä»¬æ£€æŸ¥ä½™é¢æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å…¨éƒ¨çš„è¿™äº›ï¼Œåªéœ€è¦é‚£äº›å¯ä»¥è¢«æˆ‘ä»¬æ‰€æ‹¥æœ‰çš„keyè§£é”çš„ï¼ˆç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰keyçš„å®ç°ï¼Œæˆ‘ä»¬ä¼šç”¨ç”¨æˆ·å®šä¹‰åœ°å€å»ä»£æ›¿ï¼‰ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨å…¥è´¦å’Œå‡ºè´¦ä¸Šå®šä¹‰åŠ é”å’Œè§£é”æ–¹æ³•ï¼š</p>
<pre><code class="language-go">func (in *TXInput) CanUnlockOutputWith(unlockingData string) bool {
	return in.ScriptSig == unlockingData
}

func (out *TXOutput) CanBeUnlockedWith(unlockingData string) bool {
	return out.ScriptPubKey == unlockingData
}
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬ä»…ä»…ä½¿ç”¨<code>unlockingData</code>ä¸è„šæœ¬å­—æ®µè¿›è¡Œæ¯”è¾ƒã€‚è¿™äº›æ¨¡å—å°†ä¼šåœ¨åé¢çš„æ–‡ç« è¿›è¡Œæ”¹è¿›ï¼Œåœ¨æˆ‘ä»¬å®ç°åŸºäºç§é’¥çš„åœ°å€ä¹‹åã€‚</p>
<p>ä¸‹ä¸€æ­¥-æ‰¾åˆ°åŒ…å«æœªèŠ±è´¹è¾“å‡ºçš„äº¤æ˜“-è¿™æœ‰ç‚¹å›°éš¾ï¼š</p>
<pre><code class="language-go">func (bc *Blockchain) FindUnspentTransactions(address string) []Transaction {
  var unspentTXs []Transaction
  spentTXOs := make(map[string][]int)
  bci := bc.Iterator()

  for {
    block := bci.Next()

    for _, tx := range block.Transactions {
      txID := hex.EncodeToString(tx.ID)

    Outputs:
      for outIdx, out := range tx.Vout {
        // Was the output spent?
        if spentTXOs[txID] != nil {
          for _, spentOut := range spentTXOs[txID] {
            if spentOut == outIdx {
              continue Outputs
            }
          }
        }

        if out.CanBeUnlockedWith(address) {
          unspentTXs = append(unspentTXs, *tx)
        }
      }

      if tx.IsCoinbase() == false {
        for _, in := range tx.Vin {
          if in.CanUnlockOutputWith(address) {
            inTxID := hex.EncodeToString(in.Txid)
            spentTXOs[inTxID] = append(spentTXOs[inTxID], in.Vout)
          }
        }
      }
    }

    if len(block.PrevBlockHash) == 0 {
      break
    }
  }

  return unspentTXs
}
</code></pre>
<p>å› ä¸ºäº¤æ˜“è¢«å­˜å‚¨åœ¨åŒºå—ä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ£€æŸ¥åŒºå—é“¾ä¸­çš„æ¯ä¸€ä¸ªåŒºå—ã€‚æˆ‘ä»¬ä»å‡ºè´¦å¼€å§‹ï¼š</p>
<pre><code class="language-go">if out.CanBeUnlockedWith(address) {
	unspentTXs = append(unspentTXs, tx)
}
</code></pre>
<p>å¦‚æœä¸€ç¬”å‡ºè´¦è¢«æˆ‘ä»¬æœå¯»æœªèŠ±è´¹äº¤æ˜“è¾“å‡ºçš„åœ°å€é”ä½äº†ï¼ˆä¹Ÿå°±æ˜¯ï¼šè¿™ä¸ªå‡ºè´¦çš„åœ°å€å°±æ˜¯æœå¯»æ—¶æ‰€ç”¨çš„åœ°å€ï¼‰ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„å‡ºè´¦ã€‚ä½†æ˜¯åœ¨è·å¾—å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ä¸€ä¸ªå‡ºè´¦æ˜¯å¦æ—©å·²è¢«ä¸€ä¸ªå…¥è´¦æ‰€å¼•ç”¨ï¼š</p>
<pre><code class="language-go">if spentTXOs[txID] != nil {
	for _, spentOut := range spentTXOs[txID] {
		if spentOut == outIdx {
			continue Outputs
		}
	}
}
</code></pre>
<p>æˆ‘ä»¬è·³è¿‡é‚£äº›å·²ç»è¢«å…¥è´¦æ‰€å¼•ç”¨çš„å‡ºè´¦ï¼ˆè¿™äº›å€¼æ—©å·²è½¬ç§»åˆ°å…¶ä»–å‡ºè´¦ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½è®¡ç®—å®ƒä»¬ï¼‰ã€‚åœ¨æ£€æŸ¥å‡ºè´¦ä¹‹åæˆ‘ä»¬è·å¾—æ‰€æœ‰çš„ï¼Œå¯ä»¥è¢«æä¾›çš„åœ°å€è§£é”å‡ºè´¦ä¸Šé¢çš„é”ï¼Œçš„å…¥è´¦ï¼ˆå®ƒä¸ä¼šç”¨åˆ°<code>coinbase</code>äº¤æ˜“ä¸Šï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰è§£é”å‡ºè´¦ï¼‰ï¼š</p>
<blockquote>
<p>PSï¼šè¿™é‡Œæˆ‘ç¿»è¯‘ä¸å¥½ï¼ŒæŠŠåŸæ–‡è´´ä¸Šäº†</p>
<p>After checking outputs we gather all inputs that could unlock outputs locked with the provided address (this doesnâ€™t apply to coinbase transactions, since they donâ€™t unlock outputs)</p>
</blockquote>
<pre><code class="language-go">if tx.IsCoinbase() == false {
    for _, in := range tx.Vin {
        if in.CanUnlockOutputWith(address) {
            inTxID := hex.EncodeToString(in.Txid)
            spentTXOs[inTxID] = append(spentTXOs[inTxID], in.Vout)
        }
    }
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«æœªèŠ±è´¹è¾“å‡ºçš„äº¤æ˜“åˆ—è¡¨ã€‚ä¸ºäº†è®¡ç®—ä½™é¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—äº¤æ˜“è¿”å›äº¤æ˜“è¾“å‡ºï¼š</p>
<pre><code class="language-go">func (bc *Blockchain) FindUTXO(address string) []TXOutput {
       var UTXOs []TXOutput
       unspentTransactions := bc.FindUnspentTransactions(address)

       for _, tx := range unspentTransactions {
               for _, out := range tx.Vout {
                       if out.CanBeUnlockedWith(address) {
                               UTXOs = append(UTXOs, out)
                       }
               }
       }

       return UTXOs
}
</code></pre>
<p>å°±æ˜¯å®ƒäº†ï¼ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°<code>getbalance</code>å‘½ä»¤ï¼š</p>
<pre><code class="language-go">func (cli *CLI) getBalance(address string) {
	bc := NewBlockchain(address)
	defer bc.db.Close()

	balance := 0
	UTXOs := bc.FindUTXO(address)

	for _, out := range UTXOs {
		balance += out.Value
	}

	fmt.Printf(&quot;Balance of '%s': %d\n&quot;, address, balance)
}
</code></pre>
<p>è´¦æˆ·çš„ä½™é¢æ˜¯æ‰€æœ‰è¢«è´¦æˆ·åœ°å€é”ä½çš„æœªèŠ±è´¹äº¤æ˜“è¾“å‡ºçš„æ€»é¢ã€‚</p>
<p>è®©æˆ‘ä»¬åœ¨æŒ–å‡ºåˆ›ä¸–åŒºå—åæ£€æŸ¥ä¸€ä¸‹ä½™é¢ï¼š</p>
<pre><code class="language-go">$ blockchain_go getbalance -address Ivan
Balance of 'Ivan': 10
</code></pre>
<p>è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¡¶é‡‘ï¼</p>
<h2 id="å‘é€å¸">å‘é€å¸</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æƒ³å‘é€ä¸€äº›å¸ç»™å…¶ä»–äººã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ˜“ï¼ŒæŠŠå®ƒæ”¾è¿›åŒºå—é‡Œï¼Œç„¶åæŒ–çŸ¿ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå®ç°äº†<code>coinbase</code>äº¤æ˜“ï¼ˆä¸€ç§ç‰¹æ®Šçš„äº¤æ˜“ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´æœ‰æ™®éæ€§æ„ä¹‰çš„äº¤æ˜“ï¼š</p>
<pre><code class="language-go">func NewUTXOTransaction(from, to string, amount int, bc *Blockchain) *Transaction {
	var inputs []TXInput
	var outputs []TXOutput

	acc, validOutputs := bc.FindSpendableOutputs(from, amount)

	if acc &lt; amount {
		log.Panic(&quot;ERROR: Not enough funds&quot;)
	}

	// Build a list of inputs
	for txid, outs := range validOutputs {
		txID, err := hex.DecodeString(txid)

		for _, out := range outs {
			input := TXInput{txID, out, from}
			inputs = append(inputs, input)
		}
	}

	// Build a list of outputs
	outputs = append(outputs, TXOutput{amount, to})
	if acc &gt; amount {
		outputs = append(outputs, TXOutput{acc - amount, from}) // a change
	}

	tx := Transaction{nil, inputs, outputs}
	tx.SetID()

	return &amp;tx
}
</code></pre>
<p>åœ¨åˆ›å»ºæ–°çš„è¾“å‡ºä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å¯»æ‰¾æ‰€æœ‰çš„æœªèŠ±è´¹è¾“å‡ºå¹¶ä¸”ç¡®ä¿å®ƒä»¬å­˜å‚¨äº†è¶³å¤Ÿçš„â€œé’±â€ã€‚è¿™å°±æ˜¯<code>FindSpendableOutputs</code>æ–¹æ³•æ‰€åšçš„ã€‚åœ¨é‚£ä¹‹åï¼Œå…¥è´¦æ‰€éœ€è¦å¼•ç”¨çš„å‡ºè´¦å°±è¢«æ‰¾å‡ºæ¥äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªè¾“å‡ºï¼š</p>
<ol>
<li>ä¸€ä¸ªç”±æ¥æ”¶è€…çš„åœ°å€é”å®šã€‚è¿™å°±æ˜¯çœŸå®çš„å¸åˆ°ä¸€ä¸ªåœ°å€çš„è½¬ç§»ã€‚</li>
<li>ä¸€ä¸ªç”±å‘é€è€…çš„åœ°å€é”å®šã€‚è¿™æ˜¯ä¸€ä¸ªæ”¹å˜ã€‚å®ƒä»…ä»…åœ¨æœªèŠ±è´¹äº¤æ˜“è¾“å‡ºçš„æ€»é¢å¤§äºæ–°äº¤æ˜“æ‰€éœ€è¦çš„æ€»é¢æ—¶è¢«åˆ›å»ºã€‚è®°ä½ï¼Œè¾“å‡ºæ˜¯__ä¸å¯åˆ†å‰²__çš„ã€‚</li>
</ol>
<p><code>FindSpendableOutputs</code>æ–¹æ³•ä¾èµ–äºæˆ‘ä»¬å…ˆå‰å®šä¹‰çš„<code>FindUnspentTransactions</code>æ–¹æ³•ï¼š</p>
<pre><code class="language-go">func (bc *Blockchain) FindSpendableOutputs(address string, amount int) (int, map[string][]int) {
	unspentOutputs := make(map[string][]int)
	unspentTXs := bc.FindUnspentTransactions(address)
	accumulated := 0

Work:
	for _, tx := range unspentTXs {
		txID := hex.EncodeToString(tx.ID)

		for outIdx, out := range tx.Vout {
			if out.CanBeUnlockedWith(address) &amp;&amp; accumulated &lt; amount {
				accumulated += out.Value
				unspentOutputs[txID] = append(unspentOutputs[txID], outIdx)

				if accumulated &gt;= amount {
					break Work
				}
			}
		}
	}

	return accumulated, unspentOutputs
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•è¿­ä»£æ‰€æœ‰çš„æœªèŠ±è´¹äº¤æ˜“å¹¶è®¡ç®—å®ƒä»¬çš„æ€»é¢ã€‚å½“ç§¯ç´¯çš„å€¼å¤§äºæˆ–è€…ç­‰äºæˆ‘ä»¬éœ€è¦è¿›è¡Œè½¬æ¢çš„å€¼æ—¶ï¼Œå®ƒå°±ä¼šåœæ­¢å¹¶ä¸”è¿”å›ç§¯ç´¯çš„æ€»å€¼å·²ç»ç”±äº¤æ˜“IDæ‰€èšä¼šçš„å‡ºè´¦ç´¢å¼•ã€‚æˆ‘ä»¬ä¸æƒ³èŠ±æ›´å¤šçš„é’±ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>Blockchain.MineBlock</code>æ–¹æ³•ï¼š</p>
<pre><code class="language-go">func (bc *Blockchain) MineBlock(transactions []*Transaction) {
	...
	newBlock := NewBlock(transactions, lastHash)
	...
}
</code></pre>
<blockquote>
<p>å®Œæ•´ä»£ç ï¼š</p>
<pre><code class="language-go">func (bc *Blockchain) MineBlock(transactions []*Transaction) {
	var lasthash []byte

	// BoltDBçš„åªè¯»äº‹åŠ¡ï¼Œè¯»å–æœ€åä¸€ä¸ªåŒºå—çš„hashï¼Œç”¨å®ƒæŒ–ä¸‹ä¸€ä¸ªåŒºå—çš„hash
	err := bc.db.View(func(tx *bolt.Tx) error {
		b := tx.Bucket([]byte(blocksBucket))
		lasthash = b.Get([]byte(&quot;l&quot;))

		return nil
	})

	if err!= nil {
		log.Panic(err)
	}

	// ç”¨æä¾›çš„äº¤æ˜“ä»¥åŠä¸Šä¸€ä¸ªåŒºå—çš„hashæ„å»ºæ–°çš„åŒºå—
	newBlock := NewBlock(transactions, lasthash)

	// æŒ–åˆ°æ–°åŒºå—åè¿›è¡ŒDBå­˜å‚¨å¹¶æ›´æ–°â€œlâ€é”®
	err = bc.db.Update(func(tx *bolt.Tx) error {
		b := tx.Bucket([]byte(blocksBucket))
		err := b.Put(newBlock.Hash, newBlock.Serialize())
		if err != nil {
			log.Panic(err)
		}

		// æ›´æ–°â€œlâ€é”®
		err = b.Put([]byte(&quot;l&quot;), newBlock.Hash)
		if err != nil {
			log.Panic(err)
		}

		bc.tip = newBlock.Hash

		return nil
	})
}
</code></pre>
</blockquote>
<p>æœ€åï¼Œæˆ‘ä»¬å®ç°<code>send</code>å‘½ä»¤ï¼š</p>
<pre><code class="language-go">func (cli *CLI) send(from, to string, amount int) {
	bc := NewBlockchain(from)
	defer bc.db.Close()

	tx := NewUTXOTransaction(from, to, amount, bc)
	bc.MineBlock([]*Transaction{tx})
	fmt.Println(&quot;Success!&quot;)
}
</code></pre>
<p>å‘é€å¸æ„å‘³ç€åˆ›å»ºä¸€ä¸ªäº¤æ˜“ï¼Œå¹¶ä¸”é€šè¿‡æŒ–å‡ºä¸€ä¸ªåŒºå—å°†å…¶æ·»åŠ åˆ°åŒºå—é“¾ä¸Šã€‚ä½†æ˜¯æ¯”ç‰¹å¸æ²¡æœ‰åƒæˆ‘ä»¬å®ç°è¿™äº›ã€‚ç›¸åçš„ï¼Œå®ƒæŠŠæ‰€æœ‰äº¤æ˜“å­˜å‚¨åˆ°å†…å­˜æ± ï¼ˆä¸€èˆ¬å«åšçŸ¿æ± ï¼‰ä¸­ï¼Œå½“çŸ¿å·¥å‡†å¤‡å¥½æŒ–å‡ºä¸€ä¸ªçŸ¿æ—¶ï¼Œå®ƒæ‰“åŒ…å†…å­˜æ± ä¸­çš„æ‰€æœ‰äº¤æ˜“å¹¶ä¸”äº§ç”Ÿä¸€ä¸ªå€™é€‰åŒºå—ã€‚äº¤æ˜“åªæœ‰åœ¨åŒ…å«å®ƒçš„åŒºå—è¢«æŒ–å‡ºæ¥å¹¶ä¸”æ·»åŠ åˆ°åŒºå—é“¾ä¹‹åæ‰è¢«ç¡®è®¤ã€‚</p>
<p>ç„¶æˆ‘ä»¬æ£€æŸ¥å‘é€å¸å‘½ä»¤çš„è¿è¡Œï¼š</p>
<pre><code class="language-go">$ blockchain_go send -from Ivan -to Pedro -amount 6
00000001b56d60f86f72ab2a59fadb197d767b97d4873732be505e0a65cc1e37

Success!

$ blockchain_go getbalance -address Ivan
Balance of 'Ivan': 4

$ blockchain_go getbalance -address Pedro
Balance of 'Pedro': 6
</code></pre>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºæ›´å¤šçš„äº¤æ˜“ç¡®å®šå‘é€åœ¨æ›´å¤šçš„è¾“å‡ºç¨‹åºä¸­å¯ä»¥å¾ˆå¥½çš„è¿è¡Œï¼š</p>
<pre><code class="language-go">$ blockchain_go send -from Pedro -to Helen -amount 2
00000099938725eb2c7730844b3cd40209d46bce2c2af9d87c2b7611fe9d5bdf

Success!

$ blockchain_go send -from Ivan -to Helen -amount 2
000000a2edf94334b1d94f98d22d7e4c973261660397dc7340464f7959a7a9aa

Success!
</code></pre>
<p>ç°åœ¨ï¼ŒHelen'sçš„å¸è¢«ä¸¤ä¸ªå‡ºè´¦é”å®šï¼šä¸€ä¸ªæ¥è‡ªPedroä¸€ä¸ªæ¥è‡ªIvanã€‚è®©æˆ‘ä»¬åˆ†åˆ«å‘é€å®ƒä»¬ï¼š</p>
<pre><code class="language-go">$ blockchain_go send -from Helen -to Rachel -amount 3
000000c58136cffa669e767b8f881d16e2ede3974d71df43058baaf8c069f1a0

Success!

$ blockchain_go getbalance -address Ivan
Balance of 'Ivan': 2

$ blockchain_go getbalance -address Pedro
Balance of 'Pedro': 4

$ blockchain_go getbalance -address Helen
Balance of 'Helen': 1

$ blockchain_go getbalance -address Rachel
Balance of 'Rachel': 3
</code></pre>
<p>çœ‹èµ·æ¥å¾ˆå¥½ï¼è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸ªå¤±è´¥æƒ…å†µï¼š</p>
<pre><code class="language-go">$ blockchain_go send -from Pedro -to Ivan -amount 5
panic: ERROR: Not enough funds

$ blockchain_go getbalance -address Pedro
Balance of 'Pedro': 4

$ blockchain_go getbalance -address Ivan
Balance of 'Ivan': 2
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å™¢ï¼å®ƒå¹¶ä¸å®¹æ˜“ï¼Œä½†å¥½æ­¹æˆ‘ä»¬ç°åœ¨æœ‰äº¤æ˜“äº†ï¼è™½ç„¶ï¼Œä¸€äº›ç±»ä¼¼äºåŒºå—é“¾è¿™ç§åŠ å¯†è´§å¸çš„ç‰¹æ€§é—å¤±äº†ï¼š</p>
<ol>
<li>åœ°å€ã€‚æˆ‘ä»¬æ²¡æœ‰çœŸå®çš„ï¼ŒåŸºäºç§é’¥çš„åœ°å€ã€‚</li>
<li>å¥–åŠ±ã€‚æŒ–çŸ¿æ˜¯æ¯«æ— åˆ©ç›Šå¯å›¾çš„ã€‚</li>
<li>UTXOé›†åˆã€‚éœ€è¦æ‰«ææ•´ä¸ªåŒºå—è·å¾—ä½™é¢ï¼Œå½“åŒºå—éå¸¸éå¸¸å¤šçš„æ—¶å€™è¿™å¾ˆèŠ±è´¹æ—¶é—´ã€‚è€Œä¸”åœ¨åé¢æˆ‘ä»¬è¦éªŒè¯äº¤æ˜“çš„è¯ä¹Ÿéå¸¸èŠ±è´¹æ—¶é—´ã€‚UTXOé›†å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜å¹¶ä¸”è®©äº¤æ˜“æ“ä½œæ›´å¿«æ·ã€‚</li>
<li>å†…å­˜æ± ï¼ˆçŸ¿æ± ï¼‰ã€‚è¿™æ˜¯äº¤æ˜“åœ¨æ‰“åŒ…åˆ°åŒºå—ä¹‹å‰æ‰€è¦å­˜å‚¨çš„åœ°æ–¹ã€‚åœ¨æˆ‘ä»¬ç›®å‰çš„å®ç°ä¸­ï¼Œä¸€ä¸ªåŒºå—åªåŒ…å«ä¸€ä¸ªäº¤æ˜“ï¼Œè¿™æ˜¯éå¸¸ä½æ•ˆçš„ã€‚</li>
</ol>
<p>Linksï¼š</p>
<ol>
<li><a href="https://github.com/Jeiwan/blockchain_go/tree/part_4">Full source codes</a></li>
<li><a href="https://en.bitcoin.it/wiki/Transaction">Transaction</a></li>
<li><a href="https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees">Merkle tree</a></li>
<li><a href="https://en.bitcoin.it/wiki/Coinbase">Coinbase</a></li>
</ol>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%BB%8B%E7%BB%8D">ä»‹ç»</a></li>
<li><a href="#there-is-no-spoon%E8%BF%99%E6%B2%A1%E5%8B%BA%E5%AD%90">There is no spoonï¼ˆè¿™æ²¡å‹ºå­ï¼‰</a></li>
<li><a href="#%E6%AF%94%E7%89%B9%E5%B8%81%E4%BA%A4%E6%98%93">æ¯”ç‰¹å¸äº¤æ˜“</a></li>
<li><a href="#%E4%BA%A4%E6%98%93%E5%87%BA%E8%B4%A6">äº¤æ˜“å‡ºè´¦</a></li>
<li><a href="#%E4%BA%A4%E6%98%93%E5%85%A5%E8%B4%A6">äº¤æ˜“å…¥è´¦</a></li>
<li><a href="#the-egg%E8%9B%8B">The eggï¼ˆè›‹ï¼‰</a></li>
<li><a href="#%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E5%AD%98%E5%82%A8%E4%BA%A4%E6%98%93">åœ¨åŒºå—é“¾ä¸­å­˜å‚¨äº¤æ˜“</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E">å·¥ä½œé‡è¯æ˜</a></li>
<li><a href="#%E6%9C%AA%E8%8A%B1%E8%B4%B9%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA">æœªèŠ±è´¹äº¤æ˜“è¾“å‡º</a></li>
<li><a href="#%E5%8F%91%E9%80%81%E5%B8%81">å‘é€å¸</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://lizonglin313.github.io/post/ä½¿ç”¨Golangæ„å»ºåŒºå—é“¾Part3ï¼šæŒä¹…åŒ–å’Œå‘½ä»¤è¡Œæ¥å£">
              <h3 class="post-title">
                ä½¿ç”¨Golangæ„å»ºåŒºå—é“¾Part3ï¼šæŒä¹…åŒ–å’Œå‘½ä»¤è¡Œæ¥å£
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  <a>--Â©2017-2020</a><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv"><a>--æœ¬ç«™æ€»è®¿é—®é‡</a><a><span id="busuanzi_value_site_pv"></span></a><a>æ¬¡--</a></span><a>Powered by </a> <a href="https://github.com/getgridea/gridea" target="_blank"> Gridea--</a>
  <a class="rss" href="https://lizonglin313.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
